name: OpenAI API Spec Monitor

on:
  schedule:
    - cron: "0 * * * *" # Run every hour
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  monitor:
    runs-on: ubuntu-slim
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch latest spec
        run: |
          curl -f -o cache/openapi.yml https://app.stainless.com/api/spec/documented/openai/openapi.documented.yml

      - name: Compute the diff
        id: check_changes
        run: |
          git diff --stat cache/openapi.yml
          if ! git diff --exit-code cache/openapi.yml; then
            echo "Changes detected!"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "No changes detected."
          fi

      - name: Read the diff
        if: steps.check_changes.outputs.changes_detected == 'true'
        id: read_diff
        run: |
          # Read the diff into a variable. Limit to 10000 chars.
          DIFF_CONTENT=$(git diff cache/openapi.yml | head -c 10000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze the diff
        if: steps.check_changes.outputs.changes_detected == 'true'
        uses: vercel/ai-action@v2
        id: analyze
        with:
          model: "openai/gpt-4o-mini"
          api-key: ${{ secrets.AI_GATEWAY_API_KEY }}
          schema: |
            {
              "$schema": "https://json-schema.org/draft/2020-12/schema",
              "type": "object",
              "properties": {
                "branch_name": { "type": "string", "description": "Branch name in the format type/short-description using either 'feat' or 'chore'" },
                "body": { "type": "string", "description": "Detailed description of changes in markdown" }
              },
              "required": ["branch_name", "body"],
              "additionalProperties": false
            }
          prompt: |
            You are a senior software engineer and an expert in API specifications.
            Analyze the following git diff for an OpenAI API spec file.
            Determine the type of change. Use 'feat' for actual to the API specification (endpoints, schemas, parameters), and 'chore' for anything else (updates to examples, docs, formatting, etc).
            Generate a branch name in the format `type/short-description` (e.g., `feat/new-embeddings-model` or `chore/typo-fix`).
            And generate a detailed description of the changes in markdown for a GitHub pull request.
              
            Diff:
            ${{ steps.read_diff.outputs.diff }}

      - name: Log analysis result
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          echo "Branch: ${{ fromJson(steps.analyze.outputs.json).branch_name }}"
          echo "Body: ${{ fromJson(steps.analyze.outputs.json).body }}"

      - name: Create PR
        if: steps.check_changes.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v7
        id: cpr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: ${{ fromJson(steps.analyze.outputs.json).branch_name }}
          title: ${{ fromJson(steps.analyze.outputs.json).branch_name }}
          body: ${{ fromJson(steps.analyze.outputs.json).body }}
          branch: ${{ fromJson(steps.analyze.outputs.json).branch_name }}
          delete-branch: true
          base: main

      - name: Enable auto-merge
        if: steps.cpr.outputs.pull-request-operation == 'created'
        run: gh pr merge --squash --auto "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Discord Notification
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: |
            âœ¨ OpenAI API spec updated

            **${{ fromJson(steps.analyze.outputs.json).branch_name }}**

            PR: ${{ steps.cpr.outputs.pull-request-url }}
